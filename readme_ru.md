# EasyLic // Онлайн-лицензирование программного обеспечения от TPHL

[![Python](https://img.shields.io/badge/Python-3.8+-blue.svg)](https://www.python.org/)
[![FastAPI](https://img.shields.io/badge/FastAPI-0.100+-green.svg)](https://fastapi.tiangolo.com/)
[![License](https://img.shields.io/badge/License-TPHL-orange.svg)](LICENSE)

EasyLic решает проблему пиратства программного обеспечения, требуя проверки лицензии в реальном времени, в отличие от оффлайн-систем, которые легко взламываются или делятся. Он предоставляет безопасный криптографический сервер лицензий, построенный на FastAPI, с управлением сессиями, отзывом лицензий и всесторонними функциями безопасности. Если вы новичок, начните с раздела Quick Start ниже.

**Важные замечания по безопасности:** Конечно, код должен быть скомпилирован в двоичный файл/обфусцирован, а проверки лицензии должны размещаться не в одном месте, а по всему коду. Мы также рекомендуем добавить самопроверки целостности кода через хеш файла для предотвращения подделок.

## Содержание

- [Особенности](#особенности)
- [Быстрый старт](#быстрый-старт)
- [Установка](#установка)
- [Использование CLI](#использование-cli)
- [Устранение неполадок](#устранение-неполадок)
- [Конфигурация](#конфигурация)
- [Справочник API](#справочник-api)
- [Развертывание](#развертывание)
- [Концепции и обзор безопасности](#концепции-и-обзор-безопасности)
- [Архитектура](#архитектура)
- [FAQ](#faq)
- [Разработка](#разработка)
- [Вклад](#вклад)
- [Журнал изменений](#журнал-изменений)
- [Лицензия](#лицензия)

## Особенности

EasyLic предоставляет все необходимое для безопасного лицензирования программного обеспечения:

- **Валидация в реальном времени**: Лицензии требуют онлайн-проверок, позволяя мгновенный отзыв и предотвращая пиратство.
- **Контроль многопользовательских устройств**: Устанавливайте ограничения на одновременное использование для предотвращения деления лицензий.
- **Админ-панель**: Веб-интерфейс для создания, управления и отзыва лицензий.
- **Простая интеграция**: Библиотека клиента Python с автоматическим обновлением для бесшовной интеграции в приложения.
- **Готовность к Docker**: Простое контейнеризованное развертывание.
- **Криптографическая защита**: Продвинутая безопасность с цифровыми подписями и шифрованием (см. [Концепции и обзор безопасности](#концепции-и-обзор-безопасности) для деталей).

## Быстрый старт

### Предварительные требования

Перед началом убедитесь, что у вас установлен Python 3.8+.

### Настройка сервера

1. **Установите EasyLic**:
   ```bash
   pip install easylic
   ```

2. **Установите переменные окружения**:
   ```bash
   export EASYLIC_ADMIN_PASSWORD=your_secure_password_here  # Выберите надежный пароль для доступа админа
   export EASYLIC_SERVER_HOST=0.0.0.0  # Привязать ко всем интерфейсам (или 127.0.0.1 только для локального)
   export EASYLIC_SERVER_PORT=8000  # Порт по умолчанию
   ```

3. **Сгенерируйте ключи** (обязательно):
   ```bash
   easylic keygen
   ```
   Это создаст криптографические ключи в `./easylic/server`. Если вы видите "Permission denied", убедитесь, что директория существует и доступна для записи: `mkdir -p ./easylic/server`. Или установите альтернативную директорию через `--keys-dir`.

4. **Запустите сервер**:
   ```bash
   easylic serve
   ```
   Сервер запускается на http://localhost:8000. Посетите http://localhost:8000/admin для админ-панели (войдите с вашим админ-паролем).

### Пример клиента

Интегрируйте лицензирование в ваше Python-приложение:

```python
from easylic.client.client import LicenseClient

# Загрузите лицензию и подключитесь к серверу
client = LicenseClient()

# Начните безопасную сессию
session_id = client.start_session()
print(f"Сессия начата: {session_id}")

# Проверьте, активна ли лицензия
if client.is_license_active():
    print("Лицензия действительна - ваше приложение может работать")
else:
    print("Лицензия недействительна - выйдите из приложения")

# Запустите с автоматическим обновлением в фоне
client.start_in_thread()

# Ваша логика приложения здесь
while client.is_license_active():
    # Приложение работает, пока лицензия активна
    pass
```

### Генерация лицензии (Админ)

Используйте веб-админ-панель на http://localhost:8000/admin для интерактивного создания лицензий.

Или через CLI:
```bash
easylic generator
```

Или через API: См. [Справочник API](#справочник-api) для endpoint POST /generate_license.

**Примечание:** Сгенерированная лицензия - это JSON-файл, который должен быть распределен клиентским приложениям.

## Установка

### Предварительные требования

- Python 3.8+

### Установка из PyPI

EasyLic опубликован на PyPI и может быть установлен напрямую:

```bash
pip install easylic
```

### Установка из исходного кода

```bash
git clone https://github.com/tphlru/easylic
cd easylic
pip install -e .
```

## Использование CLI

EasyLic включает инструменты командной строки для управления ключами и операциями сервера:

- **`easylic keygen`**: Генерируйте криптографические ключи для сервера. Запустите это сначала, чтобы создать `server.key` и `server.pub` в `EASYLIC_KEYS_DIR`.
- **`easylic serve`**: Запустите сервер лицензий с настроенным хостом/портом. Требует ключи от keygen.
- **`easylic generator`**: Интерактивный инструмент для создания лицензий. Запрашивает детали вроде ID лицензии, валидности и функций.

Запустите `easylic --help` для всех опций. Все команды уважают переменные окружения вроде `EASYLIC_KEYS_DIR`.

## Устранение неполадок

Распространенные проблемы и решения:

- **"Key not found" или "Permission denied" при keygen**: Убедитесь, что `EASYLIC_KEYS_DIR` (по умолчанию `./easylic/server`) существует и доступен для записи.
- **Сервер не запускается**: Проверьте, свободен ли порт (`lsof -i :8000`). Установите `EASYLIC_SERVER_PORT` на другое значение, если нужно.
- **Клиент не может подключиться**: Проверьте, что `server_url` в конфиге клиента указывает на работающий сервер (например, `http://localhost:8000`).
- **Лицензия недействительна**: Проверьте формат файла лицензии и даты. Используйте админ-панель для генерации тестовых лицензий.
- **Ограничение по скорости**: Подождите минуту; сервер ограничивает попытки старта до 10/минуту на лицензию.

## Конфигурация

EasyLic использует переменные окружения для конфигурации:

| Переменная | По умолчанию | Описание |
|------------|--------------|----------|
| `EASYLIC_SERVER_HOST` | `127.0.0.1` | Адрес привязки сервера |
| `EASYLIC_SERVER_PORT` | `8000` | Порт сервера |
| `EASYLIC_ADMIN_PASSWORD` | `admin` | Пароль для админ-операций |
| `LOG_LEVEL` | `INFO` | Уровень логирования (DEBUG, INFO, WARNING, ERROR) |
| `EASYLIC_KEYS_DIR` | `./easylic/server` | Директория для ключей сервера |

### Конфигурация клиента

Клиент может быть настроен через объект `ClientConfig` или переменные окружения:

```python
from easylic.client.client import LicenseClient
from easylic.common.models import ClientConfig

config = ClientConfig(
    server_url="http://localhost:8000",
    license_file="/path/to/license.json",
    renew_interval=30,  # секунды
    log_level=20,  # logging.INFO
)

client = LicenseClient(config)
```

## Справочник API

### Endpoints

#### `GET /health`
Endpoint проверки здоровья.

**Ответ:**
```json
{
  "status": "healthy",
  "timestamp": 1703123456
}
```

#### `POST /start`
Инициируйте безопасную сессию.

**Запрос:**
```json
{
  "version": 1,
  "license": {
    "payload": {
      "license_id": "lic-001",
      "product": "MyApp",
      "valid_from": 1704067200,
      "valid_until": 1735689600,
      "policy": {
        "version": "1.0",
        "max_sessions": 1
      }
    },
    "signature": "hex-encoded-signature"
  },
  "client_pubkey": "hex-string",
  "client_eph_pub": "hex-string",
  "supported_features": {
    "secure_channel": true,
    "counter": true,
    "pop": true,
    "transcript_binding": true,
    "rekey": true,
    "proofs": true
  }
}
```

**Ответ:**
```json
{
  "session_id": "uuid",
  "expires_at": 1703123456,
  "protocol_version": 1,
  "cipher_suite": "v1:ChaCha20Poly1305",
  "required_features": {...},
  "server_eph_pub": "hex-string",
  "nonce_prefix": "hex-string",
  "signature": "hex-string",
  "transcript_hash": "hex-string",
  "handshake_ciphertext": "hex-string",
  "handshake_nonce": "hex-string"
}
```

#### `POST /renew`
Обновите существующую сессию.

**Запрос:**
```json
{
  "session_id": "uuid",
  "ciphertext": "encrypted-renew-data",
  "counter": 1
}
```

**Ответ:**
```json
{
  "ciphertext": "encrypted-response",
  "counter": 2,
  "epoch_used": 0
}
```

#### `POST /revoke`
Отзовите лицензию (только админ).

**Запрос:**
```json
{
  "payload": {
    "license_id": "lic-001"
  },
  "signature": "admin-signature"
}
```

#### `POST /generate_license`
Сгенерируйте новую лицензию (только админ).

**Запрос:**
```json
{
  "password": "your_admin_password",
  "license_id": "lic-001",
  "product": "MyApp",
  "valid_from": 1704067200,
  "valid_until": 1735689600,
  "policy": {
    "version": "1.0",
    "max_sessions": 1,
    "features": ["feature1", "feature2"]
  }
}
```

**Ответ:**
```json
{
  "license_id": "lic-001",
  "product": "MyApp",
  "valid_from": 1704067200,
  "valid_until": 1735689600,
  "policy": {
    "version": "1.0",
    "max_sessions": 1,
    "features": ["feature1", "feature2"]
  },
  "signature": "hex-encoded-signature"
}
```

**Пример cURL:**
```bash
curl -X POST http://localhost:8000/generate_license \
  -H "Content-Type: application/json" \
  -d '{
    "password": "your_admin_password",
    "license_id": "lic-001",
    "product": "MyApp",
    "valid_from": 1704067200,
    "valid_until": 1735689600,
    "policy": {
      "version": "1.0",
      "max_sessions": 1,
      "features": ["feature1", "feature2"]
    }
  }'
```

## Развертывание

### Развертывание в Docker

#### Сборка образа
```bash
docker build -t easylic .
```

#### Запуск контейнера
```bash
# Постоянные ключи
docker run -v $(pwd)/easylic/server:/home/app/easylic/server \
           -e EASYLIC_ADMIN_PASSWORD=secure_password \
           -p 8000:8000 easylic

# Одноразовый (ключи теряются при остановке)
docker run -p 8000:8000 easylic
```

### Соображения для продакшена

- Используйте надежный `EASYLIC_ADMIN_PASSWORD`
- Храните ключи безопасно (монтирование тома или управление секретами) и создайте резервную копию
- Настройте обратный прокси (nginx) для завершения SSL

## Концепции и обзор безопасности

### Основные концепции

Чтобы начать, вот некоторые основные термины, объясненные просто:

- **Онлайн-лицензирование**: Требует интернет-соединения для валидации в реальном времени, предотвращая пиратство, позволяя мгновенный отзыв и мониторинг использования (в отличие от оффлайн-лицензий, которые можно копировать).
- **Сессия**: Временное, безопасное соединение между вашим приложением и сервером лицензий для валидации. Сессии автоматически обновляются и истекают, если лицензия недействительна.
- **Криптографическая безопасность**: Использует цифровые подписи Ed25519 (для доказательства аутентичности) и шифрование ChaCha20Poly1305 (для безопасной передачи данных) для защиты от подделок и прослушки.
- **Доказательство владения**: Клиенты доказывают владение лицензией без раскрытия секретов, используя цифровые подписи.
- **Отзыв**: Админы могут мгновенно отключить лицензии, завершая все активные сессии.
- **Одновременные сессии**: Ограничивает количество устройств, которые могут использовать одну лицензию одновременно, предотвращая деление.

### Обзор безопасности

EasyLic реализует множественные уровни безопасности для предотвращения обхода лицензирования и обеспечения политик лицензий:

- **Онлайн-валидация**: В отличие от оффлайн-лицензирования, EasyLic требует реального времени коммуникации с сервером, позволяя мгновенный отзыв и предотвращая одновременное использование лицензии на нескольких устройствах
- **Ограничения одновременных сессий**: Политика `max_sessions` предотвращает использование одной лицензии одновременно на нескольких устройствах, блокируя распространенные техники пиратства
- **Обязательные функции безопасности**: Все клиенты должны поддерживать secure_channel, counter, pop, transcript_binding, rekey и proofs
- **AEAD-шифрование**: ChaCha20Poly1305 для конфиденциальности и целостности
- **Монотонные счетчики**: Предотвращают атаки повторного воспроизведения и обеспечивают порядок сообщений
- **Привязка транскрипта**: Привязка канала к хешу транскрипта handshake
- **Периодическая ротация ключей**: Автоматическая ротация ключей каждые 10 обновлений
- **Доказательство владения**: Подписи Ed25519 для аутентификации клиента
- **Ограничение скорости**: Предотвращает DoS и атаки повторного воспроизведения на установление сессии
- **Ограничения сессий**: Жесткие ограничения на значения счетчиков для предотвращения повторного использования nonce

## Архитектура

EasyLic состоит из трех основных компонентов:

- **Клиентское приложение**: Интегрирует библиотеку `LicenseClient` для управления сессиями и автоматического обновления. Коммуницирует безопасно с сервером.
- **Сервер лицензий** (FastAPI): Обрабатывает валидацию, хранение сессий, управление ключами и криптографические операции. Основная логика безопасности находится здесь.
- **Админ-панель** (Веб-UI): Позволяет админам генерировать лицензии, отзывать их и мониторить использование.

Все компоненты полагаются на общие криптографические примитивы (подписи Ed25519 и шифрование ChaCha20Poly1305) для безопасной коммуникации.

## Состояния лицензий

Лицензии следуют строгой машине состояний:

```
INIT → ACTIVE → REKEY → ACTIVE → EXPIRED → REVOKED
```

- **INIT**: Ново выданная лицензия, еще не активирована
- **ACTIVE**: Действительная лицензия с активными сессиями
- **REKEY**: Временное состояние во время ротации ключей (каждые 10 обновлений)
- **EXPIRED**: Период валидности лицензии закончился
- **REVOKED**: Лицензия была административно отозвана

## FAQ

**Q: Почему использовать онлайн-лицензирование вместо оффлайн?**  
A: Оффлайн-лицензии можно легко копировать и делить. Онлайн-лицензирование требует валидации сервера в реальном времени, позволяя мгновенный отзыв, мониторинг использования и предотвращение распространения пиратства.

**Q: Как это предотвращает одновременное использование?**  
A: Каждая лицензия имеет ограничение `max_sessions`. Если лицензия используется на большем количестве устройств, чем разрешено, новые сессии отвергаются.

**Q: Что, если сервер недоступен?**  
A: Клиенты кешируют валидность лицензии кратковременно (обычно менее 1 минуты), но длительные отключения требуют доступности сервера. Планируйте высокую доступность в продакшене.

**Q: Можно ли использовать с не-Python приложениями?**  
A: Клиент только для Python, но вы можете интегрировать через API-вызовы к endpoints сервера.

**Q: Распространенные ошибки: "Connection failed"**  
A: Убедитесь, что сервер запущен и `server_url` в конфиге клиента указывает на правильный адрес (по умолчанию: http://localhost:8000).

**Q: "License invalid"**  
A: Проверьте формат файла лицензии, даты и убедитесь, что он не отозван через админ-панель. Также файлы ключей на сервере должны быть теми же, что использовались при создании лицензии. Если вы перевыпустите их, сервер не сможет валидировать ранее выданные лицензии, так что держите ваши бэкапы в безопасности!

**Q: Permission denied при keygen**  
A: Попробуйте установить `EASYLIC_KEYS_DIR` на записываемый путь.

## Разработка

### Тестирование

Запустите набор тестов:

```bash
pytest
```

### Линтинг

Проверьте качество кода:

```bash
ruff check .
mypy .
```

### Сервер разработки

Для разработки с авто-перезагрузкой:

```bash
uvicorn easylic.server.core:app --reload
```

## Вклад

1. Форкните репозиторий
2. Создайте ветку функции (`git checkout -b feature/amazing-feature`)
3. Зафиксируйте изменения (`git commit -m 'Add amazing feature'`)
4. Отправьте в ветку (`git push origin feature/amazing-feature`)
5. Откройте Pull Request

### Руководства по разработке

- Следуйте рекомендациям стиля PEP 8
- Добавляйте тесты для новых функций
- Обновляйте документацию при изменениях API
- Убедитесь, что все тесты проходят перед отправкой PR

## Журнал изменений

- **v0.0.0**: Первоначальный релиз с основными функциями лицензирования. См. git log для детальных изменений.
- **v0.1.0**: Опубликовано на pip!

## Лицензия

TPHL - Все права защищены.

Это программное обеспечение может использоваться только в соответствии с условиями лицензионного соглашения.
